name: Continuous Integration

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, reopened, converted_to_draft, ready_for_review]
    branches: ["*"]

env:
  CARGO_TERM_COLOR: always

defaults:
  run:
    working-directory: ./app

jobs:
  build:
    name: Build ${{ matrix.environments.title }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        environments:
          - runner: ubuntu-latest
            title: ubuntu/aarch64-gnu
            setup: '' 

          - runner: macos-latest
            title: MacOS/aarch64-gnu
            setup: |
              brew update
              brew install zig

              # create and activate a venv in $HOME to avoid PEP 668 errors
              python3 -m venv $HOME/ci-venv
              $HOME/ci-venv/bin/python -m pip install --upgrade pip
              $HOME/ci-venv/bin/python -m pip install cargo-zigbuild

              # add venv bin to PATH for subsequent steps
              echo "PATH=$HOME/ci-venv/bin:$PATH" >> $GITHUB_ENV

    runs-on: ${{ matrix.environments.runner }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      # Cache Cargo registry and target
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ./target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ matrix.environments.title }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install AArch64 Dependencies (Linux)
        if: ${{ matrix.environments.runner == 'ubuntu-latest' }}
        uses: ./.github/actions/install-aarch64-deps

      - name: Environment setup (matrix)
        if: ${{ matrix.environments.setup != '' }}
        shell: bash
        run: |
          echo "Running setup for ${{ matrix.environments.title }}"
          set -euo pipefail
          # expand and run the matrix.setup block
          ${{ matrix.environments.setup }}

      - name: Show toolchain & targets
        run: |
          rustc --version || true
          cargo --version || true
          rustup target list --installed || true

      - name: Run build
        shell: bash
        run: |
          set -e
          make build